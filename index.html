<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>QTickets WebApp</title>
    <style>
        html, body, #frame {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
        }
    </style>
    <script>
        const tg = window.Telegram?.WebApp;
        window.addEventListener('DOMContentLoaded', () => {
            if (tg) tg.ready();

            // 1) Получаем закодированный payload
            const encoded = new URLSearchParams(location.search)
                    .get('startapp')
                || tg?.initDataUnsafe?.start_param
                || '';
            if (!encoded) {
                document.body.innerHTML = '<p style="color:red; text-align:center;">Ошибка: нет startapp</p>';
                return;
            }

            // 2) Декодируем
            let raw;
            try {
                raw = decodeURIComponent(encoded);
            } catch {
                document.body.innerHTML = '<p style="color:red; text-align:center;">Неверная кодировка</p>';
                return;
            }

            // 3) Парсим в URLSearchParams
            const params = new URLSearchParams(raw);
            const eventId = params.get('event_id');
            if (!eventId) {
                document.body.innerHTML = '<p style="color:red; text-align:center;">Ошибка: нет event_id</p>';
                return;
            }

            // 4) Собираем остальные параметры (qcode и UTM)
            params.delete('event_id');
            const qs = params.toString(); // qcode=…&utm_source=…&…

            // 5) Вставляем iframe
            const iframe = document.createElement('iframe');
            iframe.id = 'frame';
            iframe.src = `https://qtickets.ru/event/${encodeURIComponent(eventId)}/${ qs ? `?${qs}` : '' }`;
            iframe.frameBorder = '0';
            document.body.appendChild(iframe);
        });
    </script>
</head>
<body></body>
</html>