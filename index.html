<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>QTickets WebApp Proxy</title>
    <style>
        html, body, #frame {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background: white;
        }
    </style>
</head>
<body>
<script>
    const queryParams = new URLSearchParams(window.location.search);
    const hash = window.location.hash || '';

    const startParamRaw = queryParams.get('tgWebAppStartParam');
    if (!startParamRaw) {
        document.body.innerHTML = '<p style="color:red; text-align:center; margin-top:2rem;">Ошибка: отсутствует параметр tgWebAppStartParam</p>';
        throw new Error('Missing tgWebAppStartParam');
    }

    const segments = startParamRaw.split('-');
    const eventId = segments.shift();
    if (!eventId) {
        document.body.innerHTML = '<p style="color:red; text-align:center; margin-top:2rem;">Ошибка: отсутствует event_id</p>';
        throw new Error('Missing event_id');
    }

    const params = new URLSearchParams();

    // Добавляем чистый eventId как tgWebAppStartParam
    params.set('tgWebAppStartParam', eventId);

    // Добавляем только валидные utm-пары
    segments.forEach(seg => {
        const [key, ...rest] = seg.split('=');
        const val = rest.join('=');
        if (key && val) {
            params.set(key, val);
        }
    });

    // Финальный URL
    const finalUrl = `https://qtickets.ru/telegram-iframe?${params.toString()}${hash}`;

    console.log("Final query params:", params.toString());  // для отладки

    const iframe = document.createElement('iframe');
    iframe.id = 'frame';
    iframe.src = finalUrl;
    iframe.frameBorder = '0';
    document.body.appendChild(iframe);
</script>
</body>
</html>